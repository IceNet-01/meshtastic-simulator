<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Network Simulator</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>Meshtastic Network Simulator</h1>
            <div class="header-actions">
                <button id="btn-save-scenario" class="btn btn-primary">Save Scenario</button>
                <button id="btn-load-scenario" class="btn btn-secondary">Load Scenario</button>
                <button id="btn-import-nodedb" class="btn btn-secondary">Import NodeDB</button>
                <button id="btn-export" class="btn btn-secondary">Export YAML</button>
                <button id="btn-import" class="btn btn-secondary">Import YAML</button>
                <button id="btn-clear" class="btn btn-danger">Clear All</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Node Configuration -->
            <aside class="panel panel-left">
                <div class="panel-section">
                    <h2>Add Node</h2>
                    <div class="form-group">
                        <label for="node-name">Name</label>
                        <input type="text" id="node-name" placeholder="Node name">
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="use-gps-coords">
                            Use GPS Coordinates
                        </label>
                    </div>
                    <div id="coord-xy" class="form-row">
                        <div class="form-group">
                            <label for="node-x">X (m)</label>
                            <input type="number" id="node-x" value="0" step="100">
                        </div>
                        <div class="form-group">
                            <label for="node-y">Y (m)</label>
                            <input type="number" id="node-y" value="0" step="100">
                        </div>
                    </div>
                    <div id="coord-gps" class="form-row hidden">
                        <div class="form-group">
                            <label for="node-lat">Latitude</label>
                            <input type="number" id="node-lat" value="0" step="0.0001" placeholder="40.7128">
                        </div>
                        <div class="form-group">
                            <label for="node-lon">Longitude</label>
                            <input type="number" id="node-lon" value="0" step="0.0001" placeholder="-74.0060">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="node-height">Height (m)</label>
                            <input type="number" id="node-height" value="1" step="1" min="0">
                        </div>
                        <div class="form-group">
                            <label for="node-gain">Gain (dBi)</label>
                            <input type="number" id="node-gain" value="0" step="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="node-role">Role</label>
                        <select id="node-role">
                            <option value="CLIENT">Client</option>
                            <option value="CLIENT_MUTE">Client Mute</option>
                            <option value="ROUTER">Router</option>
                            <option value="REPEATER">Repeater</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="node-hoplimit">Hop Limit</label>
                        <input type="range" id="node-hoplimit" min="0" max="7" value="3">
                        <span id="node-hoplimit-value">3</span>
                    </div>
                    <button id="btn-add-node" class="btn btn-primary btn-full">Add Node</button>
                </div>

                <div class="panel-section">
                    <h2>Node List (<span id="node-count">0</span>)</h2>
                    <div id="node-list" class="node-list"></div>
                </div>
            </aside>

            <!-- Center - Canvas/Map -->
            <main class="canvas-container">
                <div class="canvas-toolbar">
                    <span>Double-click to add node | Drag node to move | Scroll to zoom | Drag empty space to pan</span>
                    <div class="zoom-controls">
                        <button id="btn-zoom-in" class="btn-icon">+</button>
                        <span id="zoom-level">Z12</span>
                        <button id="btn-zoom-out" class="btn-icon">-</button>
                        <button id="btn-fit" class="btn-icon" title="Fit all nodes">Fit</button>
                    </div>
                </div>
                <canvas id="network-canvas"></canvas>
                <div class="canvas-status">
                    <span id="cursor-pos">0m, 0m</span>
                    <span id="canvas-status-text">Map: <a href="https://www.openstreetmap.org/copyright" target="_blank" style="color: #888;">OpenStreetMap</a></span>
                </div>
            </main>

            <!-- Right Panel - Simulation & Commands -->
            <aside class="panel panel-right">
                <div class="panel-section">
                    <h2>Simulation Settings</h2>
                    <div class="form-group">
                        <label for="pathloss-model">Path Loss Model</label>
                        <select id="pathloss-model">
                            <option value="0">Log-distance</option>
                            <option value="1">Okumura-Hata (small cities)</option>
                            <option value="2">Okumura-Hata (metro)</option>
                            <option value="3">Okumura-Hata (suburban)</option>
                            <option value="4">Okumura-Hata (rural)</option>
                            <option value="5" selected>3GPP (suburban macro)</option>
                            <option value="6">3GPP (metro macro)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pathloss-adjustment">Range Adjustment (dB)</label>
                        <input type="number" id="pathloss-adjustment" value="-15" step="5" min="-30" max="30">
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                            Negative = longer range. -15 dB ≈ 5km, 0 dB ≈ 2km (conservative)
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="terrain-enabled" style="width: auto;">
                            Enable Terrain Analysis
                        </label>
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                            Uses SRTM elevation data for line-of-sight checks. Requires internet.
                        </small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="area-width">Area Width (m)</label>
                            <input type="number" id="area-width" value="10000" step="1000" min="1000">
                        </div>
                        <div class="form-group">
                            <label for="area-height">Area Height (m)</label>
                            <input type="number" id="area-height" value="10000" step="1000" min="1000">
                        </div>
                    </div>
                    <button id="btn-apply-settings" class="btn btn-secondary btn-full">Apply Settings</button>
                </div>

                <div class="panel-section">
                    <h2>Channel Configuration</h2>
                    <div class="form-group">
                        <label for="channel-name">Channel Name</label>
                        <input type="text" id="channel-name" value="Default" placeholder="Channel name">
                    </div>
                    <div class="form-group">
                        <label for="channel-psk">Pre-Shared Key</label>
                        <div class="input-with-button">
                            <select id="channel-psk-type">
                                <option value="none">None (Open)</option>
                                <option value="default" selected>Default Key</option>
                                <option value="random">Random (256-bit)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <input type="text" id="channel-psk-custom" class="hidden" placeholder="Base64 encoded key">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="channel-encryption-enabled" checked>
                            Encryption Enabled
                        </label>
                    </div>
                    <div class="encryption-status" id="encryption-status">
                        <span class="status-icon encrypted">&#128274;</span>
                        <span class="status-text">Messages are encrypted</span>
                    </div>
                </div>

                <div class="panel-section">
                    <h2>Commands</h2>
                    <div class="command-section">
                        <h3>Broadcast</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cmd-broadcast-from">From Node</label>
                                <select id="cmd-broadcast-from"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cmd-broadcast-text">Message</label>
                            <input type="text" id="cmd-broadcast-text" placeholder="Enter message">
                        </div>
                        <button id="btn-broadcast" class="btn btn-primary btn-full">Send Broadcast</button>
                    </div>

                    <div class="command-section">
                        <h3>Direct Message</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cmd-dm-from">From</label>
                                <select id="cmd-dm-from"></select>
                            </div>
                            <div class="form-group">
                                <label for="cmd-dm-to">To</label>
                                <select id="cmd-dm-to"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cmd-dm-text">Message</label>
                            <input type="text" id="cmd-dm-text" placeholder="Enter message">
                        </div>
                        <button id="btn-dm" class="btn btn-primary btn-full">Send DM</button>
                    </div>

                    <div class="command-section">
                        <h3>Traceroute</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cmd-trace-from">From</label>
                                <select id="cmd-trace-from"></select>
                            </div>
                            <div class="form-group">
                                <label for="cmd-trace-to">To</label>
                                <select id="cmd-trace-to"></select>
                            </div>
                        </div>
                        <button id="btn-traceroute" class="btn btn-primary btn-full">Run Traceroute</button>
                    </div>
                </div>

                <div class="panel-section">
                    <h2>Link Quality</h2>
                    <div id="link-info" class="link-info">
                        <p class="hint">Select two nodes to see link quality</p>
                    </div>
                </div>

                <div class="panel-section">
                    <h2>Network Statistics <button id="btn-refresh-stats" class="btn-icon" title="Refresh">&#8635;</button></h2>
                    <div id="network-stats" class="stats-panel">
                        <div class="stat-row">
                            <span class="stat-label">Nodes:</span>
                            <span id="stat-total-nodes" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Connectivity:</span>
                            <span id="stat-connectivity" class="stat-value">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Hops:</span>
                            <span id="stat-avg-hops" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Network Diameter:</span>
                            <span id="stat-diameter" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg SNR:</span>
                            <span id="stat-avg-snr" class="stat-value">0 dB</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Coverage Area:</span>
                            <span id="stat-coverage" class="stat-value">0 km²</span>
                        </div>
                        <div class="stat-group">
                            <span class="stat-label">Links:</span>
                            <div class="link-quality-bars">
                                <div class="quality-bar good" id="stat-links-good" title="Good quality"></div>
                                <div class="quality-bar medium" id="stat-links-medium" title="Medium quality"></div>
                                <div class="quality-bar poor" id="stat-links-poor" title="Poor quality"></div>
                            </div>
                            <span id="stat-links-total" class="stat-value">0</span>
                        </div>
                        <div id="isolated-nodes-warning" class="warning-box hidden">
                            <span class="warning-icon">&#9888;</span>
                            <span id="isolated-nodes-text">0 isolated nodes</span>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer / Log -->
        <footer class="app-footer">
            <div class="log-header">
                <h3>Message Log</h3>
                <button id="btn-clear-log" class="btn-icon" title="Clear log">Clear</button>
            </div>
            <div id="message-log" class="message-log"></div>
        </footer>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Import Node Configuration</h2>
            <textarea id="import-yaml" placeholder="Paste YAML configuration here..."></textarea>
            <div class="modal-actions">
                <button id="btn-import-cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn-import-confirm" class="btn btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- NodeDB Import Modal -->
    <div id="nodedb-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <h2>Import from Meshtastic NodeDB</h2>
            <p class="hint">Paste NodeDB JSON export from Meshtastic Python CLI or app, or load from file</p>

            <div class="form-group">
                <label for="nodedb-file">Load from File</label>
                <input type="file" id="nodedb-file" accept=".json,.txt" style="margin-bottom: 8px;">
            </div>

            <div class="form-group">
                <label for="nodedb-json">NodeDB JSON</label>
                <textarea id="nodedb-json" placeholder='{"nodes": {...}} or "Nodes in mesh: {...}"' rows="6"></textarea>
            </div>

            <div class="nodedb-filters">
                <h3>Filters</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="filter-require-position" checked>
                            Require GPS position
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="filter-clear-existing" checked>
                            Clear existing nodes
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filter-max-hops">Max Hops Away</label>
                        <select id="filter-max-hops">
                            <option value="">Any</option>
                            <option value="0">Direct only (0)</option>
                            <option value="1">1 hop</option>
                            <option value="2">2 hops</option>
                            <option value="3">3 hops</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-last-heard">Last Heard Within</label>
                        <select id="filter-last-heard">
                            <option value="">Any time</option>
                            <option value="3600">1 hour</option>
                            <option value="86400">24 hours</option>
                            <option value="604800">7 days</option>
                            <option value="2592000">30 days</option>
                        </select>
                    </div>
                </div>
                <h3>Default Node Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filter-default-height">Default Height (m)</label>
                        <input type="number" id="filter-default-height" value="2" step="0.5" min="0">
                    </div>
                    <div class="form-group">
                        <label for="filter-default-gain">Antenna Gain (dBi)</label>
                        <input type="number" id="filter-default-gain" value="2" step="1">
                    </div>
                    <div class="form-group">
                        <label for="filter-default-hoplimit">Hop Limit</label>
                        <input type="number" id="filter-default-hoplimit" value="3" min="0" max="7">
                    </div>
                </div>
                <div class="form-group">
                    <label>Node Roles</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" class="filter-role" value="CLIENT" checked> Client</label>
                        <label><input type="checkbox" class="filter-role" value="CLIENT_MUTE" checked> Client Mute</label>
                        <label><input type="checkbox" class="filter-role" value="CLIENT_BASE" checked> Client Base</label>
                        <label><input type="checkbox" class="filter-role" value="ROUTER" checked> Router</label>
                        <label><input type="checkbox" class="filter-role" value="ROUTER_CLIENT" checked> Router Client</label>
                        <label><input type="checkbox" class="filter-role" value="ROUTER_LATE" checked> Router Late</label>
                        <label><input type="checkbox" class="filter-role" value="REPEATER" checked> Repeater</label>
                        <label><input type="checkbox" class="filter-role" value="TRACKER" checked> Tracker</label>
                    </div>
                </div>
            </div>

            <div id="nodedb-preview" class="nodedb-preview hidden">
                <h3>Preview (<span id="preview-count">0</span> nodes will be imported)</h3>
                <div class="preview-stats">
                    <span class="stat">Total: <span id="preview-total">0</span></span>
                    <span class="stat skip">No Position: <span id="preview-no-pos">0</span></span>
                    <span class="stat skip">Too Far: <span id="preview-too-far">0</span></span>
                    <span class="stat skip">Too Old: <span id="preview-too-old">0</span></span>
                </div>
                <div id="preview-list" class="preview-list"></div>
            </div>

            <div class="modal-actions">
                <button id="btn-nodedb-preview" class="btn btn-secondary">Preview</button>
                <button id="btn-nodedb-cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn-nodedb-import" class="btn btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- Node Edit Modal -->
    <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Edit Node <span id="edit-node-id"></span></h2>
            <div class="form-group">
                <label for="edit-name">Name</label>
                <input type="text" id="edit-name">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-x">X (m)</label>
                    <input type="number" id="edit-x" step="100">
                </div>
                <div class="form-group">
                    <label for="edit-y">Y (m)</label>
                    <input type="number" id="edit-y" step="100">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-height">Height (m)</label>
                    <input type="number" id="edit-height" step="1" min="0">
                </div>
                <div class="form-group">
                    <label for="edit-gain">Gain (dBi)</label>
                    <input type="number" id="edit-gain" step="1">
                </div>
            </div>
            <div class="form-group">
                <label for="edit-role">Role</label>
                <select id="edit-role">
                    <option value="CLIENT">Client</option>
                    <option value="CLIENT_MUTE">Client Mute</option>
                    <option value="ROUTER">Router</option>
                    <option value="REPEATER">Repeater</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-hoplimit">Hop Limit</label>
                <input type="range" id="edit-hoplimit" min="0" max="7" value="3">
                <span id="edit-hoplimit-value">3</span>
            </div>
            <div class="modal-actions">
                <button id="btn-edit-delete" class="btn btn-danger">Delete Node</button>
                <button id="btn-edit-cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn-edit-save" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Save Scenario Modal -->
    <div id="save-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Save Scenario</h2>
            <div class="form-group">
                <label for="scenario-name">Scenario Name</label>
                <input type="text" id="scenario-name" placeholder="My Network Setup">
            </div>
            <div class="form-group">
                <label for="scenario-description">Description (optional)</label>
                <textarea id="scenario-description" rows="3" placeholder="Describe your network configuration..."></textarea>
            </div>
            <div class="modal-actions">
                <button id="btn-save-cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn-save-confirm" class="btn btn-primary">Save &amp; Download</button>
            </div>
        </div>
    </div>

    <!-- Load Scenario Modal -->
    <div id="load-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Load Scenario</h2>
            <div class="form-group">
                <label for="scenario-file">Select Scenario File</label>
                <input type="file" id="scenario-file" accept=".json,.scenario">
            </div>
            <div id="scenario-preview" class="scenario-preview hidden">
                <h3>Scenario Preview</h3>
                <div class="preview-info">
                    <div><strong>Name:</strong> <span id="scenario-preview-name"></span></div>
                    <div><strong>Nodes:</strong> <span id="scenario-preview-nodes"></span></div>
                    <div><strong>Saved:</strong> <span id="scenario-preview-date"></span></div>
                    <div><strong>Description:</strong> <span id="scenario-preview-desc"></span></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btn-load-cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn-load-confirm" class="btn btn-primary" disabled>Load Scenario</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for loading scenarios -->
    <input type="file" id="scenario-file-input" accept=".json,.scenario" style="display: none;">

    <script src="/static/js/app.js"></script>
</body>
</html>
